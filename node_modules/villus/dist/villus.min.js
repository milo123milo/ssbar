/**
  * villus v1.0.1
  * (c) 2021 Abdelrahman Awad
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue"),require("graphql")):"function"==typeof define&&define.amd?define(["exports","vue","graphql"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Villus={},e.Vue,e.graphql)}(this,(function(e,t,r){"use strict";function n(e,r){var n;const o=t.getCurrentInstance(),u=t.inject(e,null===(n=null==o?void 0:o.provides)||void 0===n?void 0:n[e]);if(null==u)throw r();return u}function o(e){return"string"==typeof e?new r.GraphQLError(e):"object"==typeof e&&e.message?new r.GraphQLError(e.message,e.nodes,e.source,e.positions,e.path,e,e.extensions||{}):e}class u extends Error{constructor({response:e,networkError:t,graphqlErrors:r}){const n=null==r?void 0:r.map(o),u=((e,t)=>{let r="";return void 0!==e?r=`[Network] ${e.message}`:(void 0!==t&&t.forEach((e=>{r+=`[GraphQL] ${e.message}\n`})),r.trim())})(t,n);super(u),this.name="CombinedError",this.response=e,this.message=u,this.networkError=t,this.graphqlErrors=n}get isGraphQLError(){return!(!this.graphqlErrors||!this.graphqlErrors.length)}toString(){return this.message}}var s=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var r,n="boolean"==typeof t.cycles&&t.cycles,o=t.cmp&&(r=t.cmp,function(e){return function(t,n){var o={key:t,value:e[t]},u={key:n,value:e[n]};return r(o,u)}}),u=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var r,s;if(Array.isArray(t)){for(s="[",r=0;r<t.length;r++)r&&(s+=","),s+=e(t[r])||"null";return s+"]"}if(null===t)return"null";if(-1!==u.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var a=u.push(t)-1,i=Object.keys(t).sort(o&&o(t));for(s="",r=0;r<i.length;r++){var c=i[r],l=e(t[c]);l&&(s&&(s+=","),s+=JSON.stringify(c)+":"+l)}return u.splice(a,1),"{"+s+"}"}}(e)};function a(e){return"string"==typeof e?e:e&&e.kind?r.print(e):null}async function i(e){let t;const r={ok:e.ok,statusText:e.statusText,status:e.status,headers:e.headers};try{t=await e.json()}catch(e){return Object.assign(Object.assign({},r),{statusText:e.message,body:null})}return Object.assign(Object.assign({},r),{body:t})}const c={method:"POST",headers:{"content-type":"application/json"}};function l({query:e,variables:t},r){const n=a(e);if(!n)throw new Error("A query must be provided.");return o={body:JSON.stringify({query:n,variables:t})},u=r,Object.assign(Object.assign(Object.assign({},o),u),{method:u.method||o.method||c.method,headers:Object.assign(Object.assign({},o.headers||{}),u.headers||{})});var o,u}function f(e){let t,r,n;for(t=5381,r=0,n=0|e.length;r<n;r++)t=(t<<5)+t+e.charCodeAt(r);return t>>>0}function d(e,...t){const r=e.variables?s(e.variables):"";return f(`${a(e.query)}${r}${t.join("")}`)}function y(e,t){return e.slots.default&&e.slots.default(t)||[]}function h(){const e={};return function({afterQuery:t,useResult:r,operation:n}){if("query"!==n.type||"network-only"===n.cachePolicy)return;t((t=>{!function({key:t},r){e[t]=r}(n,t)}));const o=function({key:t}){return e[t]}(n);return"cache-only"===n.cachePolicy?r(o||{data:null,error:null},!0):o?r(o,"cache-first"===n.cachePolicy):void 0}}function p(e){const t=(null==e?void 0:e.fetch)||("undefined"!=typeof window&&"fetch"in window&&window.fetch?window.fetch.bind(window):"undefined"!=typeof global&&"fetch"in global?global.fetch:void 0);if(!t)throw new Error("Could not resolve a fetch() method, you should provide one.");return async function(e){var r,n;const{useResult:o,opContext:s,operation:a}=e,c=l(a,s);let f;try{f=await t(s.url,c).then(i)}catch(e){return o({data:null,error:new u({response:f,networkError:e})},!0)}e.response=f;const d=null===(r=f.body)||void 0===r?void 0:r.data;if(!f.ok||!f.body){const e={response:f};return(null===(n=f.body)||void 0===n?void 0:n.errors)?e.graphqlErrors=f.body.errors:e.networkError=new Error(f.statusText),o({data:d,error:new u(e)},!0)}o({data:d,error:f.body.errors?new u({response:f,graphqlErrors:f.body.errors}):null},!0)}}function v(){const e={};return function(t){if("query"!==t.operation.type)return;const{useResult:r}=t;if(t.afterQuery((()=>{delete e[t.operation.key]})),e[t.operation.key])return e[t.operation.key].then((e=>{r(e,!0)}));let n;e[t.operation.key]=new Promise((e=>{n=e})),t.useResult=function(...e){r(...e),n(e[0])}}}const b=Symbol("villus.client"),g=()=>[h(),v(),p()];class w{constructor(e){this.install=()=>{},this.url=e.url,this.defaultCachePolicy=e.cachePolicy||"cache-first",this.plugins=e.use||[...g()]}async execute(e,t,r,n){let o;const u=Object.assign(Object.assign({url:this.url},c),{headers:Object.assign(Object.assign({},c.headers),(null==r?void 0:r.headers)||{})});let s=!1;const a=[],i={useResult(e,t){t&&(s=!0),o&&(null==n||n(e)),o=e},afterQuery(e){a.push(e)},operation:Object.assign(Object.assign({},e),{key:d(e),type:t,cachePolicy:("cachePolicy"in e?e.cachePolicy:this.defaultCachePolicy)||this.defaultCachePolicy}),opContext:u};let l=0;for(let e=0;e<this.plugins.length;e++){const t=this.plugins[e];if(await t(i),o){l=e;break}}return new Promise(((e,t)=>{o?(e(o),(async()=>{if(!s)for(let e=l+1;e<this.plugins.length;e++){const t=this.plugins[e];await t(i)}const e={response:i.response};for(let t=0;t<a.length;t++){const r=a[t];await r(o,e)}})()):t(new Error("Operation result was not set by any plugin, make sure you have default plugins configured or review documentation"))}))}async executeQuery(e,t,r){return this.execute(e,"query",t,r)}async executeMutation(e,t){return this.execute(e,"mutation",t)}async executeSubscription(e){return await this.execute(e,"subscription")}}function m(e){const t=new w(e);return t.install=e=>e.provide(b,t),t}function O(e){const r=m(e);return t.provide(b,r),r}const q=t.defineComponent({name:"VillusClientProvider",props:{url:{type:String,required:!0},cachePolicy:{type:String,default:""},use:{type:Array,default:void 0}},setup:(e,t)=>(O({url:e.url,cachePolicy:e.cachePolicy,use:e.use}),()=>y(t,{}))});function j(e){const r=n(b,(()=>new Error("Cannot detect villus Client, did you forget to call `useClient`?")));let{query:o,variables:u,cachePolicy:a,fetchOnMount:i}=function(e){const t={variables:{},fetchOnMount:!0};return Object.assign(Object.assign(Object.assign({},t),e),{query:e.query})}(e);const c=t.ref(null),l=t.ref(null!=i&&i),d=t.ref(!1),y=t.ref(null);let h,p;function v(e){c.value=e.data,y.value=e.error}async function g(n){l.value=!0;const s=(t.isRef(u)?u.value:u)||{},i=r.executeQuery({query:t.isRef(o)?o.value:o,variables:(null==n?void 0:n.variables)||s,cachePolicy:(null==n?void 0:n.cachePolicy)||a},t.unref(null==e?void 0:e.context),v);h=i;const f=await i;return i!==h?{data:f.data,error:f.error}:(v(f),d.value=!0,l.value=!1,h=void 0,{data:c.value,error:y.value})}t.isRef(o)&&t.watch(o,(()=>g()));const w=t.ref(!0);function m(){let e;if(!t.isRef(u)&&!t.isReactive(u)||!u)return;const r=function(e){if(t.isRef(e))return e;if(t.isReactive(e)){const r=t.toRefs(e);return Object.keys(r).map((e=>r[e]))}throw new Error("value is not reactive")}(u);w.value=!0,p=t.watch(r,(t=>{const r=f(s(t));r!==e&&(e=r,g())}),{deep:!0})}m();const O={data:c,isFetching:l,isDone:d,error:y,execute:g,unwatchVariables:function(){w.value&&(p(),w.value=!1)},watchVariables:function(){w.value||m()},isWatchingVariables:w};return t.onMounted((()=>{i&&g()})),Object.assign(Object.assign({},O),{then:async e=>(i=!1,await O.execute(),e(O))})}const x=t.defineComponent({name:"Query",props:{query:{type:[String,Object],required:!0},variables:{type:Object,default:null},cachePolicy:{type:String,default:void 0},watchVariables:{type:Boolean,default:!0},suspended:{type:Boolean,default:!1},fetchOnMount:{type:Boolean,default:!0}},setup(e,r){function n(n){const{data:o,error:u,isFetching:s,isDone:a,execute:i,watchVariables:c,isWatchingVariables:l,unwatchVariables:f}=n;return t.watch(t.toRef(e,"watchVariables"),(e=>{e!==l.value&&(e?c():f())}),{immediate:!0}),()=>{const e={data:o.value,error:u.value,isFetching:s.value,isDone:a.value,execute:i};return y(r,e)}}const o={query:t.toRef(e,"query"),variables:t.toRef(e,"variables"),fetchOnMount:e.fetchOnMount,cachePolicy:e.cachePolicy};return e.suspended?j(o).then(n):n(j(o))}});function C(e,r){const o=n(b,(()=>new Error("Cannot detect villus Client, did you forget to call `useClient`?"))),u=t.ref(null),s=t.ref(!1),a=t.ref(!1),i=t.ref(null);let c;return{data:u,isFetching:s,isDone:a,error:i,execute:async function(n){s.value=!0;const l=n||{},f=o.executeMutation({query:e,variables:l},t.unref(null==r?void 0:r.context));c=f;const d=await f;return f!==c?{data:d.data,error:d.error}:(u.value=d.data,i.value=d.error,a.value=!0,s.value=!1,c=void 0,{data:u.value,error:i.value})}}}const P=t.defineComponent({name:"Mutation",props:{query:{type:[String,Object],required:!0}},setup(e,t){const{data:r,isFetching:n,isDone:o,error:u,execute:s}=C(e.query);return()=>y(t,{data:r.value,isFetching:n.value,isDone:o.value,error:u.value,execute:s})}}),E=(e,t)=>t.data;function k({query:e,variables:r,paused:o},s=E){const a=n(b,(()=>new Error("Cannot detect villus Client, did you forget to call `useClient`?"))),i=t.ref(s(null,{data:null,error:null})),c=t.ref(null),l=t.ref(o||!1);function f(e){i.value=s(i.value,e),c.value=e.error}async function d(){l.value=!1;return(await a.executeSubscription({query:t.unref(e),variables:t.unref(r)})).subscribe({next(e){if(l.value)return;f(function(e){if(!e.errors)return{data:e.data||null,error:null};return{data:e.data||null,error:new u({graphqlErrors:[...e.errors],response:null})}}(e))},complete(){},error(e){if(l.value)return;return f({data:null,error:new u({networkError:e,response:null})})}})}let y;async function h(){y&&y.unsubscribe(),y=await d()}return o||t.onMounted((async()=>{y=await d()})),t.onBeforeUnmount((()=>{y&&y.unsubscribe()})),t.isRef(e)&&t.watch(e,h),t.isRef(r)&&t.watch(r,h),{data:i,error:c,isPaused:l,pause:function(){l.value=!0},resume:async function(){y||h(),l.value=!1}}}const S=t.defineComponent({name:"Subscription",props:{query:{type:[String,Object],required:!0},variables:{type:Object,default:null},paused:{type:Boolean,default:!1},reduce:{type:Function,default:void 0}},setup(e,r){const{data:n,error:o,pause:u,isPaused:s,resume:a}=k({query:e.query,variables:e.variables,paused:e.paused},e.reduce||E);return t.watch(t.toRef(e,"paused"),(e=>{e!==s.value&&(e?u():a())})),()=>{const e={data:n.value,error:o.value,pause:u,isPaused:s.value,resume:a};return y(r,e)}}});e.Client=w,e.CombinedError=u,e.Mutation=P,e.Provider=q,e.Query=x,e.Subscription=S,e.VILLUS_CLIENT=b,e.cache=h,e.createClient=m,e.dedup=v,e.defaultPlugins=g,e.definePlugin=function(e){return e},e.fetch=p,e.getQueryKey=d,e.handleSubscriptions=function(e){const t=e;return function({operation:e,useResult:r}){if("subscription"===e.type){if(!t)throw new Error("No subscription forwarder was set.");r(t(e),!0)}}},e.useClient=O,e.useMutation=C,e.useQuery=j,e.useSubscription=k,e.withProvider=function(e,r){return t.defineComponent({name:"VillusWithClientHoc",setup:(n,o)=>(O(r),()=>t.h(e,Object.assign(Object.assign({},n),o.attrs),o.slots))})},Object.defineProperty(e,"__esModule",{value:!0})}));